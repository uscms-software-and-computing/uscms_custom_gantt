<!DOCTYPE html>
<html>
<head>
    <title>Software & Computing Gantt Chart</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="frappe-gantt.css">
    <script src="frappe-gantt.js" ></script>
</head>
<body>
<p>Software & Computing Gantt Chart</p>

<!--Add buttons to initiate auth sequence and sign out-->
<button id="authorize_button" style="display: none;">Authorize</button>
<button id="signout_button" style="display: none;">Sign Out</button>

<pre id="content" style="white-space: pre-wrap;"></pre>

<select name="year" id="year_select">
    <option value="2020">2020</option>
    <option value="2021" selected>2021</option>
</select>

<select name="wbs_area" id="wbs_area_select">
    <option value="all" selected>All</option>
    <option value="wbs1">WBS1</option>
    <option value="wbs2">WBS2</option>
    <option value="wbs3">WBS3</option>
    <option value="wbs4">WBS4</option>
</select>

<!--<input type="checkbox" id="minor_filter">Include minor milestones?-->

<br>
<button id="update_button">Update</button>


<div class="card" style="overflow: scroll">
    <svg id="gantt"></svg>
</div>

<script type="module" >
    let gantt;
    import project_data from './data/all_results.json' assert {type: 'json'};

    function filterData(data) {
        const byYear = document.getElementById('year_select');
        var yearSelect = byYear.options[byYear.selectedIndex];
        var chartYear = yearSelect.value;
        const cb = false
        const byWBS = document.getElementById('wbs_area_select');
        var opt = byWBS.options[byWBS.selectedIndex];
        var wbsFilter = opt.value;

        if (wbsFilter != 'all') {
            var wbs = data.reduce(function (res, value) {
                var wbsGroup = value.custom_class.split("-");
                if ("wbs" + wbsGroup[1] == wbsFilter) {
                    res.push(value)
                }
                return res;

            }, []);
            return wbs;
        } else {
            return data;
        }

    }


    function filterData2020(data) {
        // const cb = document.getElementById('minor_filter');
        const byYear = document.getElementById('year_select');
        var yearSelect = byYear.options[byYear.selectedIndex];
        var chartYear = yearSelect.value;
        const cb = false
        const byWBS = document.getElementById('wbs_area_select');
        var opt = byWBS.options[byWBS.selectedIndex];
        var wbsFilter = opt.value;
        // var major = [];
        // if (cb.checked) {
        if (cb || chartYear == "2020") {
            var major = data.reduce(function (res, value) {
                var major = value.id.split(".");
                if ((major[2] == "00")) {
                    res.push(value);
                }
                return res;
            }, []);
            data = major
        }

        // var wbs = [];
        if (wbsFilter != 'all') {
            var wbs = data.reduce(function (res, value) {
                var wbsGroup = value.custom_class.split("-");
                if ("wbs" + wbsGroup[1] == wbsFilter) {
                    res.push(value)
                }
                return res;

            }, []);
            return wbs;
        } else {
            return data;
        }

        // return data;

    }

    function makeGantt() {

        const byYear = document.getElementById('year_select');
        let yearSelect = byYear.options[byYear.selectedIndex];
        let chartYear = yearSelect.value;

        let tasks = project_data._embedded.elements.reduce(function (res, value) {
            let dependents = [];
            if (value._links.ancestors !== undefined) {
                dependents = value._links.ancestors.reduce(function (dep, child) {
                    const regex = /\/(\d+)/gm;
                    const str = child.href;
                    console.log(str);
                    let child_id = regex.exec(str)[1].toString();
                    dep.push(child_id)
                    return dep
                }, []);
            }
            let row = {
                id: value.id.toString(),
                name: value.subject,
                start: value.startDate || value.date,
                end: value.dueDate || value.date,
                progress: value.percentageDone,
                dependencies: dependents.join(", "),
                custom_class: value._links.project.title.toLowerCase() + '-color'
            };
            res.push(row);
            return res;
        }, []);
        // let filterTasks = filterData(tasks);
        console.log(tasks);
        let filterTasks = tasks;
        if (gantt == null) {
            gantt = new Gantt('#gantt', filterTasks, {column_width: 5});
        } else {
            gantt.refresh(filterTasks)
        }
        gantt.change_view_mode('Month');
        }

    makeGantt()

</script>

<!--<script async defer src="https://apis.google.com/js/api.js"-->
<!--        onload="this.onload=function(){};handleClientLoad()"-->
<!--        onreadystatechange="if (this.readyState === 'complete') this.onload()">-->
<!--</script>-->

<!--<script src="frappe-gantt.js" >-->

<!--var gantt = new Gantt('#gantt', [], {column_width: 5});-->

<!--</script>-->



</body>
</html>
